<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Absence;
use Carbon\Carbon;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class AbsenceController extends Controller
{
    /**
     * 本日の欠席一覧取得
     */
    public function today()
    {
        $absences = Absence::with(['student.classModel'])
            ->where('is_deleted', false) // 削除されていないもののみ
            ->whereDate('absence_date', Carbon::today())
            ->orderBy('created_at', 'desc')
            ->get();

        return response()->json($absences);
    }

    /**
     * 欠席一覧取得（日付指定可能）
     */
    public function index(Request $request)
    {
        $admin = Auth::guard('admin')->user();
        $query = Absence::with(['student.classModel'])
            ->where('is_deleted', false); // 削除されていないもののみ

        // 担任の場合は自分のクラスのみ表示
        if ($admin && !$admin->is_super_admin && $admin->class_id) {
            $query->whereHas('student', function ($q) use ($admin) {
                $q->where('class_id', $admin->class_id);
            });
        }

        // 日付範囲でフィルタ
        if ($request->has('date_from') && $request->date_from !== '') {
            $query->whereDate('absence_date', '>=', $request->date_from);
        }

        if ($request->has('date_to') && $request->date_to !== '') {
            $query->whereDate('absence_date', '<=', $request->date_to);
        }

        // 単一日付でフィルタ（後方互換性）
        if ($request->has('date') && $request->date !== '') {
            $query->whereDate('absence_date', $request->date);
        }

        // 区分でフィルタ
        if ($request->has('division') && $request->division !== '') {
            $query->where('division', $request->division);
        }

        // 学年でフィルタ
        if ($request->has('grade') && $request->grade !== '') {
            $grade = $request->grade;
            $query->whereHas('student.classModel', function ($q) use ($grade) {
                $q->where('class_name', 'LIKE', $grade . '%');
            });
        }

        // クラスIDでフィルタ
        if ($request->has('class_id')) {
            $query->whereHas('student', function ($q) use ($request) {
                $q->where('class_id', $request->class_id);
            });
        }

        // クラス名でフィルタ
        if ($request->has('class_name')) {
            $query->whereHas('student.classModel', function ($q) use ($request) {
                $q->where('class_name', $request->class_name);
            });
        }

        $absences = $query->orderBy('absence_date', 'desc')
                         ->orderBy('created_at', 'desc')
                         ->paginate($request->get('per_page', 20));

        return response()->json($absences);
    }

    /**
     * 欠席統計情報取得
     */
    public function stats()
    {
        $admin = Auth::guard('admin')->user();
        
        // 本日の欠席数
        $todayQuery = Absence::where('is_deleted', false) // 削除されていないもののみ
                       ->whereDate('absence_date', Carbon::today())
                       ->where('division', '欠席');
        
        // 担任の場合は自分のクラスのみ
        if ($admin && !$admin->is_super_admin && $admin->class_id) {
            $todayQuery->whereHas('student', function ($q) use ($admin) {
                $q->where('class_id', $admin->class_id);
            });
        }
        $today = $todayQuery->count();

        // 今週の欠席数（月曜日〜日曜日）
        $weekQuery = Absence::where('is_deleted', false) // 削除されていないもののみ
                ->whereBetween('absence_date', [
                    Carbon::now()->startOfWeek(),
                    Carbon::now()->endOfWeek()
                ])
                ->where('division', '欠席');
        
        if ($admin && !$admin->is_super_admin && $admin->class_id) {
            $weekQuery->whereHas('student', function ($q) use ($admin) {
                $q->where('class_id', $admin->class_id);
            });
        }
        $week = $weekQuery->count();

        // 今月の欠席数
        $monthQuery = Absence::where('is_deleted', false)
                       ->whereYear('absence_date', Carbon::now()->year)
                       ->whereMonth('absence_date', Carbon::now()->month)
                       ->where('division', '欠席');
        
        if ($admin && !$admin->is_super_admin && $admin->class_id) {
            $monthQuery->whereHas('student', function ($q) use ($admin) {
                $q->where('class_id', $admin->class_id);
            });
        }
        $month = $monthQuery->count();

        // 総欠席数
        $totalQuery = Absence::where('is_deleted', false)
                       ->where('division', '欠席');
        
        if ($admin && !$admin->is_super_admin && $admin->class_id) {
            $totalQuery->whereHas('student', function ($q) use ($admin) {
                $q->where('class_id', $admin->class_id);
            });
        }
        $total = $totalQuery->count();

        return response()->json([
            'today' => $today,
            'week' => $week,
            'month' => $month,
            'total' => $total,
        ]);
    }

    /**
     * 月別欠席統計取得
     */
    public function monthly()
    {
        $admin = Auth::guard('admin')->user();
        $currentYear = Carbon::now()->year;
        $monthlyData = [];

        // 過去6ヶ月分のデータを取得（新しい月から古い月へ）
        for ($i = 0; $i <= 5; $i++) {
            $date = Carbon::now()->subMonths($i);
            $query = Absence::where('is_deleted', false)
                           ->whereYear('absence_date', $date->year)
                           ->whereMonth('absence_date', $date->month)
                           ->where('division', '欠席');
            
            // 担任の場合は自分のクラスのみ
            if ($admin && !$admin->is_super_admin && $admin->class_id) {
                $query->whereHas('student', function ($q) use ($admin) {
                    $q->where('class_id', $admin->class_id);
                });
            }
            
            $count = $query->count();

            $monthlyData[] = [
                'month' => $date->format('Y年n月'),
                'count' => $count
            ];
        }

        return response()->json($monthlyData);
    }

    /**
     * 欠席詳細取得
     */
    public function show($id)
    {
        $absence = Absence::where('is_deleted', false)
                         ->with(['student.classModel'])
                         ->findOrFail($id);
        return response()->json($absence);
    }
}
